# Squid proxy configuration for Dify Sandbox SSRF protection
# This configuration ensures secure network access from the sandbox

# Basic access control
acl localnet src 10.0.0.0/8      # RFC1918 possible internal network
acl localnet src 172.16.0.0/12   # RFC1918 possible internal network  
acl localnet src 192.168.0.0/16  # RFC1918 possible internal network
acl localnet src fc00::/7         # RFC 4193 local private network range
acl localnet src fe80::/10        # RFC 4291 link-local (directly plugged) machines

# Safe ports - allow common web services
acl SSL_ports port 443
acl Safe_ports port 80    # http
acl Safe_ports port 443   # https
acl Safe_ports port 8080  # common web services
acl Safe_ports port 8443  # common web services

# Method restrictions
acl CONNECT method CONNECT

# Deny access to unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports
http_access deny CONNECT !SSL_ports

# Allow manager access from localhost
http_access allow localhost manager
http_access deny manager

# Allow localhost connections
http_access allow localhost

# Block access to local/internal networks to prevent SSRF
http_access deny localnet

# Allow access to external networks
http_access allow all

# Deny everything else
http_access deny all

# Squid configuration
http_port 3128

# Cache configuration - minimal caching for security
cache_mem 256 MB
maximum_object_size_in_memory 512 KB
cache_dir null /dev/null

# Logging
access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log

# DNS configuration
dns_nameservers 8.8.8.8 8.8.4.4

# Request/response size limits
request_header_max_size 64 KB
reply_header_max_size 64 KB

# Connection timeouts
connect_timeout 30 seconds
request_timeout 60 seconds

# Forwarded headers for debugging (remove in production)
forwarded_for on
via on

# Process management
shutdown_lifetime 3 seconds

# Prevent caching of private data
refresh_pattern .		0	20%	4320

# Security headers
reply_header_add X-Proxy-By "Dify-Sandbox-SSRF-Proxy" 